## 1 概述

### 1.3 TCP/IP 分层
 - 链路层 ARP
 - 网络层 IP(不可靠), ICMP
 - 运输层 TCP(可靠), UDP 
 - 应用层  

### 1.4 互联网的地址
 - A 类 0xxxxxxx(7位网络号).xxxxxxxx.xxxxxxxx.xxxxxxx (24位 主机号)
 - B 类 10xxxxxx.xxxxxxxx(14位网络号).xxxxxxxx.xxxxxxx (16位 主机号)
 - C 类 110xxxxx.xxxxxxxx.xxxxxxxx(21位网络号).xxxxxxx (8位 主机号)
 - D 类 1110xxxx.xxxxxxxx.xxxxxxxx.xxxxxxx (28位 多播组号)
 - E 类 11110xxx.xxxxxxxx.xxxxxxxx.xxxxxxx (27位 留着后用)

分类网络于1993年被无类别域间路由取代以解决这个问题

### 1.6 封装
当应用程序用TCP传送数据时，数据被送入协议栈中，然后逐个通过每一层直到被当作一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部信息）

### 1.7 分用 
就是反封装

### 1.9 端口号
16 bit的端口号来识别应用程序(2^16 个)， 类 UNIX  系统 1~1024 需要 root 权限，/etc/services 有常用服务。

## 2 链路层

### 2.1 引言
（1）为IP模块发送和接收IP数据报；
（2）为ARP模块发送ARP请求和接收ARP应答；
（3）为RARP发送RARP请求和接收RARP应答。TCP/IP支持多种不同的链路层协议，这取决于网络所使用的硬件，如以太网、令牌环网、FDDI（光纤分布式数据接口）及RS-232串行线路等。

### 2.2 以太网和IEEE 802封装
以太网和IEEE 802封装差异，还好长度一样。

![net](./_images/52im_1.png)

 - SLIP：串行线路IP
 - 压缩的SLIP
 - PPP：点对点协议
 - 环回接口 127.0.0.1(localhost)
  - 传给环回地址（一般是127.0.0.1）的任何数据均作为IP输入。
  - 传给广播地址或多播地址的数据报复制一份传给环回接口，然后送到以太网上。
  - 任何传给该主机IP地址的数据均送到环回接口。

 - 最大传输单元MTU
 - 路径MTU
 - 串行线路吞吐量计算


## IP:网际协议

### 3.1 引言
 - 不可靠（unreliable）的意思是它不能保证IP数据报能成功地到达目的地。
 - 无连接（connectionless）这个术语的意思是IP并不维护任何关于后续数据报的状态信息。

### 3.2 IP首部
普通的IP首部长为20个字节，除非含有选项字段。

![](./_images/ip-head.png)

#### 服务类型（TOS）
字段包括一个3bit的优先权子字段（现在已被忽略），4bit的TOS子字段和1bit未用位但必须置0 。
4bit的TO S分别代表:最小时延、最大吞吐量、最高可靠性和最小费用.如果所有4bit均为0，那么就意味着是一般服务。RFC 1340。

#### 总长度
总长度字段是指整个IP数据报的长度，以字节为单位。  
16比特，所以IP数据报最长可达65535字节。  
尽管可以传送一个长达65535字节的IP数据报，但是大多数的链路层都会对它进行分片。而且，主机也要求不能接收超过576字节的数据报。  
但是，事实上现在大多数的实现（特别是那些支持网络文件系统NFS的实现）允许超过8192字节的IP数据报。
必要字段 ，因为一些数据链路（如以太网）需要填充一些数据以达到最小长度。

#### TTL（time-to-live）
生存时间字段设置了数据报可以经过的最多路由器数。它指定了数据报的生存时间。TTL的初始值由源主机设置（通常为32或64），一旦经过一个处理它的路由器，它的值就减去1。


#### 首部检验和字段
是根据IP首部计算的检验和码。它不对首部后面的数据进行计算。ICMP、IGMP、UDP和TCP在它们各自的首部中均含有同时覆盖首部和数据检验和码。  
 计算方式：首先把检验和字段置为0。然后，对首部中每个16 bit进行二进制反码求和（整个首部看成是由一串16 bit的字组成），结果存在检验和字段中，正常值应全为1，如 不是则丢包。
由于路由器经常只修改TTL字段（减1），因此当路由器转发一份报文时可以增加它的检验和，而不需要对IP整个首部进行重新计算。

#### 源IP地址和目的IP地址

#### 任选项
 - 安全和处理限制（用于军事领域)
 - 记录路径
 - 时间戳
 - 宽松的源站选路
 - 严格的源站选路


### 3.3 IP路由选择

主机区别于路由器是转不转发数据报文  

IP可以从TCP、UDP、ICMP和IGMP接收数据报（即在本地生成的数据报）并进行发送，或者从一个网络接口接收数据报（待转发的数据报）并进行发送。IP层在内存中有一个路由表。当收到一份数据报并进行发送时，它都要对该表搜索一次。当数据报来自某个网络接口时，IP首先检查目的IP地址是否为本机的IP地址之一或者IP广播地址。如果确实是这样，数据报就被送到由IP首部协议字段所指定的协议模块进行处理。如果数据报的目的不是这些地址，那么（1）如果IP层被设置为路由器的功能，那么就对数据报进行转发（也就是说，像下面对待发出的数据报一样处理）；否则（2）数据报被丢弃。

#### 路由表信息
 - 目的IP地址。它既可以是一个完整的主机地址，也可以是一个网络地址，由该表目中的标志字段来指定
 - 下一站（或下一跳）路由器（next-hop router）的IP地址，或者有直接连接的网络IP地址。
 - 标志。其中一个标志指明目的IP地址是网络地址还是主机地址，另一个标志指明下一站路由器是否为真正的下一站路由器，还是一个直接相连的接口
 - 为数据报的传输指定一个网络接口。

IP路由选择是逐跳地（hop-by-hop）进行的。它假定下一站路由器比发送数据报的主机更接近目的。

#### IP路由选择主要完成功能
 - 搜索路由表，寻找能与目的IP地址完全匹配的表目（网络号和主机号都要匹配）
 - 搜索路由表，寻找能与目的网络号相匹配的表目。
 - 搜索路由表，寻找标为“默认（default）”的表目。

如果不能传送的数据报来自本机，那么一般会向生成数据报的应用程序返回一个“主机不可达”或“网络不可达”的错误。
完整主机地址匹配在网络号匹配之前执行。只有当它们都失败后才选择默认路由。
为一个网络指定一个路由器，而不必为每个主机指定一个路由器，这是IP路由选择机制的另一个基本特性。这样做可以极大地缩小路由表的规模。

### 3.4 子网寻址
现在所有的主机都要求支持子网编址（RFC 950[Mogul and Postel 1985]）,主机号再分成一个子网号和一个主机号。

### 3.5 子网掩码
任何主机在引导时进行的部分配置是指定主机IP地址。
除了IP地址以外，主机还需要知道有多少比特用于子网号及多少比特用于主机号。这是在引导过程中通过子网掩码来确定的。
给定IP地址和子网掩码以后，主机就可以确定IP数据报的目的
 - 本子网上的主机
 - 本网络中其他子网中的主机；
 - 其他网络上的主机。

## 4 ARP:地址解析协议
当一台主机把以太网数据帧发送到位于同一局域网上的另一台主机时，是根据48 bit的以太网地址来确定目的接口的。设备驱动程序从不检查IP数据报中的目的IP地址。
ARP为IP地址到对应的硬件地址之间提供动态映射。

### 4.3 ARP高速缓存
ARP高效运行的关键是由于每个主机上都有一个ARP高速缓存。 高速缓存中每一项的生存时间一般为20分钟，起始时间从被创建时开始算起。

`arp -a` 查询本机的 arp
`tcpdump -e arp #-e  去掉省略网卡地址` 查看 arp 查询报文

一些特殊的功能：委托ARP（当路由器对来自于另一个路由器接口的ARP请求进行应答时）和免费ARP（发送自己IP地址的ARP请求，一般发生在引导过程中）。

## 5 RARP:逆地址解析协议
RARP协议是许多无盘系统在引导时用来获取IP地址的。RARP分组格式基本上与ARP分组一致。一个RARP请求在网络上进行广播，它在分组中标明发送端的硬件地址，以请求相应IP地址的响应。应答通常是单播传送的。

RARP带来的问题包括使用链路层广播，这样就阻止大多数路由器转发RARP请求，只返回很少信息：只是系统的IP地址。

## 6 ICMP:Internet控制报文协议
ICMP经常被认为是IP层的一个组成部分。它传递差错报文以及其他需要注意的信息。ICMP报文通常被IP层或更高层协议（TCP或UDP）使用。

ICMP报文是在IP数据报内部被传输的
![](./_images/icmp-head.png)

所有报文的前4个字节都是一样的,类型字段可以有15个不同的值，以描述特定类型的ICMP报文。检验和字段覆盖整个ICMP报文,ICMP的检验和是必需的。
![](./_images/icmp-pac.png)



